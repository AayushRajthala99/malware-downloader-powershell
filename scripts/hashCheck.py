import os
import re
import hashlib
import sys
from urllib.parse import urlparse
from pathlib import Path
from os import path as directoryPath
import json


def hashGeneration(filename):
    with open(filename, "rb") as f:
        bytes = f.read()  # read entire file as bytes
        md5hash = hashlib.md5(bytes).hexdigest()
        sha256hash = hashlib.sha256(bytes).hexdigest()
        return [md5hash, sha256hash]


if (len(sys.argv) == 2):
    resultDirectory = sys.argv[1]
    malwareDirectory = resultDirectory + 'downloadedMalwares/'
    hashFileLocation = resultDirectory + 'hashCheck.json'
    urlFileLocation = resultDirectory + 'urls.txt'

    urlList = open(urlFileLocation, 'r')
    urlList = urlList.read().splitlines()

    obj = []
    if directoryPath.isfile(hashFileLocation) is False:
        # print("hashCheck.json File Created!")
        f = open(hashFileLocation, "x")
        f.write('[]')
        f.close()
    else:
        f = open(hashFileLocation, 'w')
        f.write('[]')
        f.close()

    with open(hashFileLocation) as fp:
        obj = json.load(fp)

    count = 1
    malwareList = os.listdir(malwareDirectory)
    for url in urlList:
        if (len(url) != 0):
            fullName = None
            filename = Path(url).stem
            searchName = f"{str(count)}-{filename}"
            hashInfo = {
                "id": count,
                "url": url,
                "filename": 'N/A',
                "fileExists": 'N/A',
                "md5": 'N/A',
                "sha256": 'N/A',
                "hashMatched": 'N/A'
            }

            # Getting Filename.Extension if exists
            for file in malwareList:
                if re.search(searchName, file):
                    fullName = file
                    break

            filePath = malwareDirectory + fullName
            if directoryPath.isfile(filePath) is True:
                fileHash = hashGeneration(filePath)
                hashInfo["filename"] = fullName
                hashInfo["md5"] = fileHash[0]
                hashInfo["sha256"] = fileHash[1]
                hashInfo["fileExists"] = True
                if (fileHash[1] == Path(filePath).stem):
                    hashInfo["hashMatched"] = True
                    # print(file, '--File Hash Matched!')
                else:
                    hashInfo["hashMatched"] = False
                    # print(file, '--File Hash Not Matched!')
            else:
                hashInfo["fileExists"] = False

            obj.append(hashInfo)
            count += 1

    with open(hashFileLocation, 'w') as json_file:
        json.dump(obj, json_file,
                  indent=4,
                  separators=(',', ': '))

    os.system(f"python scripts\jsontocsv.py {resultDirectory}")
else:
    print('Invalid Number of Arguments')
