import os
import hashlib
import sys
from pathlib import Path
from os import path as directoryPath
import json


def hashGeneration(filename):
    with open(filename, "rb") as f:
        bytes = f.read()  # read entire file as bytes
        md5hash = hashlib.md5(bytes).hexdigest()
        sha256hash = hashlib.sha256(bytes).hexdigest()
        return [md5hash, sha256hash]


if (len(sys.argv) == 2):
    resultDirectory = sys.argv[1]
    filesDirectory = resultDirectory + 'downloadedMalwares/'
    hashFileLocation = resultDirectory + 'hashCheck.json'

    fileList = os.listdir(filesDirectory)
    if (len(fileList) != 0):
        count = 1
        obj = []
        if directoryPath.isfile(hashFileLocation) is False:
            open(hashFileLocation, "x")
            # print("hashCheck.json File Created!")
            f = open(hashFileLocation, "w")
            f.write('[]')
            f.close()

        with open(hashFileLocation) as fp:
            obj = json.load(fp)

        for file in fileList:
            filePath = filesDirectory+file
            fileHash = hashGeneration(filePath)
            hashInfo = {
                "id": count,
                "file": file,
                "md5": fileHash[0],
                "sha256": fileHash[1],
                "hashMatched": None
            }

            if (fileHash[1] == Path(filePath).stem):
                hashInfo["hashMatched"] = True
                # print(file, '--File Hash Matched!')

            else:
                hashInfo["hashMatched"] = False
                # print(file, '--File Hash Not Matched!')

            obj.append(hashInfo)
            count = count + 1

        with open(hashFileLocation, 'w') as json_file:
            json.dump(obj, json_file,
                      indent=4,
                      separators=(',', ': '))
    else:
        print("No Files in "+filesDirectory)
        if directoryPath.isfile(hashFileLocation) is True:
            os.remove(hashFileLocation)
else:
    print('Invalid Number of Arguments')
