import os
import hashlib
import sys
from pathlib import Path
from os import path as directoryPath
import json

resultDirectory = sys.argv[1]
filesDirectory = resultDirectory + 'downloadedMalwares/'
hashFileLocation = resultDirectory+'hashCheck.json'


def sha256sum(filename):
    with open(filename, "rb") as f:
        bytes = f.read()  # read entire file as bytes
        readable_hash = hashlib.sha256(bytes).hexdigest()
        return readable_hash


if (len(sys.argv) == 2):
    fileList = os.listdir(filesDirectory)
    if (len(fileList) != 0):
        count = 1
        obj = []
        if directoryPath.isfile(hashFileLocation) is False:
            open(hashFileLocation, "x")
            print("hashCheck.json File Created!")
            f = open(hashFileLocation, "w")
            f.write('[]')
            f.close()

        with open(hashFileLocation) as fp:
            obj = json.load(fp)

        for file in fileList:
            filePath = filesDirectory+file
            if (sha256sum(filePath) == Path(filePath).stem):
                hashInfo = {
                    "id": count,
                    "file": file,
                    "hashMatched": "True"
                }
                obj.append(hashInfo)
                # print(file, '--File Hash Matched!')

            else:
                hashInfo = {
                    "id": count,
                    "file": file,
                    "hashMatched": "False"
                }
                obj.append(hashInfo)
                # print(file, '--File Hash Not Matched!')

            count = count + 1

        with open(hashFileLocation, 'w') as json_file:
            json.dump(obj, json_file,
                      indent=4,
                      separators=(',', ': '))
    else:
        print("No Files in "+filesDirectory)
        if directoryPath.isfile(hashFileLocation) is True:
            os.remove(hashFileLocation)
else:
    print('Invalid Number of Arguments')
